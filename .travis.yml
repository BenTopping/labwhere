if: tag IS blank
language: ruby
dist: xenial

cache:
  bundler: true

before_install:
- export TZ=Europe/London

before_script:
- export RAILS_ENV=test
- cp config/database.yml.example config/database.yml
- cp config/secrets.yml.example config/secrets.yml
- bundle exec rails db:setup
- bundle exec rails about

script:
- bundle exec rspec

before_deploy:
- "./compile-build"
- export TAG_NAME=${TRAVIS_BRANCH}/$(date +'%Y-%m-%d/%H%M%S')
- git tag "${TAG_NAME}"

deploy:
  provider: releases
  api_key:
    secure: Nz+1tthHMuYX1Vhdj4FWIAxPDXR+uagRgPqhtM45t8R8cWmgKBabLgkqbObfAi+wDDjUreFDuBdbSIOCxE1xnXj7Wk6qxdQ2r+ZEpyhUgC6DH/TGid3qgzYifqDygbX6Kwq2CUMKhJxqjyEJazcaIapNcAIowi0B3I+iR+cNi3Y=
  file: release.tar.gz
  skip_cleanup: true
  on:
    repo: sanger/labwhere
    all_branches: true
    condition: $TRAVIS_BRANCH =~ ^uat|master$ # only build a release on uat and master branches

notifications:
  slack:
    secure: w6bQVdf/bOmp01Oa4FESHbIyHgmnchFXb+JGaBqd6Hf+KnilYlhGtY5YisXpM4Gvja0URjIN3/6jWFl9XeiaGSkH6z+HyRFtwfx1YrQODPOKQMwgjx872jQuhEOjsCE66KK+lnEHuGBxj864rJzMPGlEg96KHanH2VtU0L/bC2e2oE+ng9/rNqkM0rT94E/tFoddTUEBJkG4CrDtvsx1J6CwFM2Oi6TwYaRAJQcFOTzIWpPJm2FoO6jzNcOfrpP1sGav30G+WMWXjU39toY06j8yOm3iqovTeTBH+WdqkImvcCXqpkvIf/QW51v5iSHzKPR9tI0lq7HLbWm4cqXPgSZlMppwR4ZUJDNiB3xX7jLqN7sRHHWWCQufJ4HhjVIYOwpuxWz8t72HZKYMwixOydkkY1Boy3fSCsTeA7y7gg8kw97JQXcs+1WYgZIGz0sao7zxcWOMhplNWFlfJ53FFVDuuHj5+pM9rDqtmOSwU4IKDk0TK/PagAJboBmet9X6n/pf+PPXBIyY1QwNK0mGZKgloo4AwAFQKlMzyyq+Je6MHwSoIf/9NJT/RmNmCEd6t/cf2sp/Oz9pB38aj7id++LL3LyfsMMTSdV/Zd+mT6hjCH7kkFGs6/6b+arKq4PotEoS2uRkNDDpBb0oYHS9TsdNMuM0KlBkjcFy1E/dnXc=
